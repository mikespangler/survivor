generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                      String                   @id @default(uuid())
  clerkId                 String                   @unique
  email                   String?                  @unique
  name                    String?
  systemRole              String                   @default("user")
  lastViewedLeagueId      String?
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  ownedLeagues            League[]
  teams                   Team[]
  memberLeagues           League[]                 @relation("LeagueMembers")
  commissionerLeagues     League[]                 @relation("LeagueCommissioners")
  questionTemplates       QuestionTemplate[]
  createdInviteTokens     InviteToken[]
  lastViewedLeague        League?                  @relation("LastViewedLeague", fields: [lastViewedLeagueId], references: [id], onDelete: SetNull)
  notificationPreferences NotificationPreferences?
  sentNotifications       SentNotification[]

  @@index([clerkId])
  @@index([lastViewedLeagueId])
}

model League {
  id            String         @id @default(cuid())
  name          String
  description   String?
  ownerId       String
  createdAt     DateTime       @default(now())
  owner         User           @relation(fields: [ownerId], references: [id])
  leagueSeasons LeagueSeason[]
  members       User[]         @relation("LeagueMembers")
  commissioners User[]         @relation("LeagueCommissioners")
  inviteTokens  InviteToken[]
  lastViewedBy  User[]         @relation("LastViewedLeague")
}

model LeagueSeason {
  id              String                @id @default(cuid())
  leagueId        String
  seasonId        String
  draftConfigs    DraftConfig[]
  league          League                @relation(fields: [leagueId], references: [id], onDelete: Cascade)
  season          Season                @relation(fields: [seasonId], references: [id], onDelete: Cascade)
  settings        LeagueSeasonSettings?
  teams           Team[]
  leagueQuestions LeagueQuestion[]
  retentionConfigs RetentionConfig[]

  @@unique([leagueId, seasonId])
}

model Team {
  id             String              @id @default(cuid())
  name           String
  logoImageUrl   String?
  leagueSeasonId String
  ownerId        String
  totalPoints    Int                 @default(0)
  createdAt      DateTime           @default(now())
  leagueSeason   LeagueSeason        @relation(fields: [leagueSeasonId], references: [id], onDelete: Cascade)
  owner          User                @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  roster         TeamCastaway[]
  answers        PlayerAnswer[]
  episodePoints  TeamEpisodePoints[]
}

model Season {
  id            String         @id @default(cuid())
  number        Int            @unique
  name          String
  status        String
  startDate     DateTime?
  activeEpisode Int            @default(1)
  castaways     Castaway[]
  episodes      Episode[]
  leagueSeasons LeagueSeason[]
}

model Castaway {
  id       String         @id @default(cuid())
  name     String
  seasonId String
  status   String
  imageUrl String?
  season   Season         @relation(fields: [seasonId], references: [id], onDelete: Cascade)
  teams    TeamCastaway[]
}

model TeamCastaway {
  id           String   @id @default(cuid())
  teamId       String
  castawayId   String
  startEpisode Int
  endEpisode   Int?
  castaway     Castaway @relation(fields: [castawayId], references: [id], onDelete: Cascade)
  team         Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, castawayId, startEpisode])
}

model Episode {
  id       String    @id @default(cuid())
  seasonId String
  number   Int
  airDate  DateTime?
  title    String?
  season   Season    @relation(fields: [seasonId], references: [id], onDelete: Cascade)

  @@unique([seasonId, number])
}

model LeagueSeasonSettings {
  id             String       @id @default(cuid())
  leagueSeasonId String       @unique
  settings       Json?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  leagueSeason   LeagueSeason @relation(fields: [leagueSeasonId], references: [id], onDelete: Cascade)
}

model DraftConfig {
  id               String       @id @default(cuid())
  leagueSeasonId   String
  roundNumber      Int          @default(1)
  castawaysPerTeam Int
  draftDate        DateTime?
  status           String       @default("PENDING")
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  leagueSeason     LeagueSeason @relation(fields: [leagueSeasonId], references: [id], onDelete: Cascade)

  @@unique([leagueSeasonId, roundNumber])
  @@index([leagueSeasonId])
}

// System-wide question templates (managed by system admins)
model QuestionTemplate {
  id              String           @id @default(cuid())
  text            String
  type            String           // 'MULTIPLE_CHOICE' | 'FILL_IN_THE_BLANK'
  options         Json?            // For MC: ["Option A", "Option B", ...]
  pointValue      Int              @default(1)
  category        String?          // e.g., "Elimination", "Challenge", "Social"
  createdById     String
  createdBy       User             @relation(fields: [createdById], references: [id])
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  leagueQuestions LeagueQuestion[]

  @@index([category])
}

// League-specific questions for an episode
model LeagueQuestion {
  id             String            @id @default(cuid())
  leagueSeasonId String
  leagueSeason   LeagueSeason      @relation(fields: [leagueSeasonId], references: [id], onDelete: Cascade)
  episodeNumber  Int
  templateId     String?
  template       QuestionTemplate? @relation(fields: [templateId], references: [id])
  text           String
  type           String
  options        Json?
  pointValue     Int               @default(1)
  correctAnswer  String?           // Set by commissioner after episode
  isScored       Boolean           @default(false)
  sortOrder      Int               @default(0)
  questionScope  String            @default("episode") // "episode" | "season"
  isWager        Boolean           @default(false)
  minWager       Int?              // For wager questions
  maxWager       Int?              // For wager questions
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  answers        PlayerAnswer[]

  @@index([leagueSeasonId, episodeNumber])
}

// Player answers
model PlayerAnswer {
  id               String         @id @default(cuid())
  leagueQuestionId String
  leagueQuestion   LeagueQuestion @relation(fields: [leagueQuestionId], references: [id], onDelete: Cascade)
  teamId           String
  team             Team           @relation(fields: [teamId], references: [id], onDelete: Cascade)
  answer           String
  wagerAmount      Int?           // Points wagered (for wager questions)
  pointsEarned     Int?           // null until scored
  submittedAt      DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  @@unique([leagueQuestionId, teamId])
  @@index([teamId])
}

// Invite tokens for league invitations
model InviteToken {
  id         String   @id @default(cuid())
  leagueId   String
  league     League   @relation(fields: [leagueId], references: [id], onDelete: Cascade)
  token      String   @unique
  createdById String
  createdBy  User     @relation(fields: [createdById], references: [id])
  expiresAt  DateTime
  usedAt     DateTime?
  usedById   String?
  createdAt  DateTime @default(now())

  @@index([token])
  @@index([leagueId])
}

// Retention points configuration per episode
model RetentionConfig {
  id                String       @id @default(cuid())
  leagueSeasonId    String
  episodeNumber     Int
  pointsPerCastaway Int          // Commissioner-configurable points per active castaway
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  leagueSeason      LeagueSeason @relation(fields: [leagueSeasonId], references: [id], onDelete: Cascade)

  @@unique([leagueSeasonId, episodeNumber])
  @@index([leagueSeasonId])
}

// Episode-by-episode point tracking for teams
model TeamEpisodePoints {
  id                  String   @id @default(cuid())
  teamId              String
  episodeNumber       Int
  questionPoints      Int      @default(0)  // Points from weekly questions
  retentionPoints     Int      @default(0)  // Points from active castaways
  totalEpisodePoints  Int      @default(0)  // Sum of question + retention
  runningTotal        Int      @default(0)  // Cumulative total through this episode
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  team                Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, episodeNumber])
  @@index([teamId])
  @@index([episodeNumber])
}

// User notification preferences
model NotificationPreferences {
  id                       String   @id @default(cuid())
  userId                   String   @unique
  user                     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Player notifications
  weeklyQuestionsReminder  Boolean  @default(true)
  draftReminder            Boolean  @default(true)
  resultsAvailable         Boolean  @default(true)

  // Commissioner notifications
  scoringReminder          Boolean  @default(true)
  questionsSetupReminder   Boolean  @default(true)

  // Timing
  emailFrequency           String   @default("immediate") // "immediate" | "daily_digest" | "never"
  reminderHoursBefore      Int      @default(24)

  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt
}

// Track sent notifications to prevent duplicates
model SentNotification {
  id               String   @id @default(cuid())
  userId           String
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  notificationType String
  leagueId         String?
  episodeNumber    Int?
  sentAt           DateTime @default(now())

  @@unique([userId, notificationType, leagueId, episodeNumber])
  @@index([userId])
}
