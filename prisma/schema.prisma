// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             String   @id @default(uuid())
  clerkId        String   @unique
  email          String?  @unique
  name           String?
  systemRole     String   @default("user")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  ownedLeagues   League[]
  memberLeagues  League[] @relation("LeagueMembers")
  teams          Team[]

  @@index([clerkId])
}

model League {
  id              String         @id @default(cuid())
  name            String         // "Mike's Friend Group"
  description     String?
  ownerId         String         // commissioner
  owner           User           @relation(fields: [ownerId], references: [id])
  members         User[]         @relation("LeagueMembers") // persistent members
  leagueSeasons   LeagueSeason[]
  createdAt       DateTime       @default(now())
}

model LeagueSeason {
  id           String                @id @default(cuid())
  leagueId     String
  league       League                @relation(fields: [leagueId], references: [id], onDelete: Cascade)
  seasonId     String
  season       Season                @relation(fields: [seasonId], references: [id], onDelete: Cascade)
  teams        Team[]
  settings     LeagueSeasonSettings?
  draftConfigs DraftConfig[]
  
  @@unique([leagueId, seasonId]) // each league plays each season once
}

model Team {
  id             String        @id @default(cuid())
  name           String
  leagueSeasonId String
  leagueSeason   LeagueSeason  @relation(fields: [leagueSeasonId], references: [id], onDelete: Cascade)
  ownerId        String
  owner          User          @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  roster         TeamCastaway[]
  totalPoints    Int           @default(0)
}

model Season {
  id            String         @id @default(cuid())
  number        Int            @unique
  name          String         // "Survivor 45: Worlds Apart"
  status        String         // SeasonStatus: UPCOMING, ACTIVE, COMPLETED
  startDate     DateTime?
  castaways     Castaway[]
  episodes      Episode[]
  leagueSeasons LeagueSeason[]
}

model Castaway {
  id        String         @id @default(cuid())
  name      String
  seasonId  String
  season    Season         @relation(fields: [seasonId], references: [id], onDelete: Cascade)
  status    String         // "active", "eliminated", "jury"
  teams     TeamCastaway[]
}

model TeamCastaway {
  id          String   @id @default(cuid())
  teamId      String
  team        Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  castawayId  String
  castaway    Castaway @relation(fields: [castawayId], references: [id], onDelete: Cascade)
  
  @@unique([teamId, castawayId])
}

model Episode {
  id        String   @id @default(cuid())
  seasonId  String
  season    Season   @relation(fields: [seasonId], references: [id], onDelete: Cascade)
  number    Int
  airDate   DateTime?
  title     String?
  
  @@unique([seasonId, number])
}

model LeagueSeasonSettings {
  id             String       @id @default(cuid())
  leagueSeasonId String       @unique
  leagueSeason   LeagueSeason @relation(fields: [leagueSeasonId], references: [id], onDelete: Cascade)
  settings       Json?        // General league settings (scoring rules, etc.)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
}

model DraftConfig {
  id              String       @id @default(cuid())
  leagueSeasonId String
  leagueSeason    LeagueSeason @relation(fields: [leagueSeasonId], references: [id], onDelete: Cascade)
  roundNumber     Int          @default(1)
  castawaysPerTeam Int
  draftDate       DateTime?
  status          String       @default("PENDING") // PENDING, IN_PROGRESS, COMPLETED
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  
  @@unique([leagueSeasonId, roundNumber])
  @@index([leagueSeasonId])
}
